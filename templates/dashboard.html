<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EchoNomics Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* --- Echonomics THEME (Based on your Dribbble shot) --- */
      :root {
        --bg-dark: #0b0c10; /* Deepest background */
        --bg-card: #12131a; /* Card background */
        --border-color: #23242e;
        --text-main: #464444;
        --text-muted: #eeeff4;

        /* Accents */
        --accent-green: #879c91;
        --accent-blue: #0095ff;
        --accent-purple: #885af8;
        --accent-yellow: #ffb547;
        --accent-red: #ff3d57;
      }

      body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        font-family: "Inter", sans-serif;
        overflow-x: hidden;
      }

      /* --- LAYOUT --- */
      .wrapper {
        display: flex;
        min-height: 100vh;
        width: 100%;
      }

      /* Sidebar */
      .sidebar {
        width: 250px;
        background-color: var(--bg-card);
        border-right: 1px solid var(--border-color);
        padding: 24px;
        display: flex;
        flex-direction: column;
        position: fixed;
        height: 100vh;
        z-index: 100;
      }

      .nav-item {
        padding: 12px 16px;
        color: var(--text-muted);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 12px;
        border-radius: 12px;
        margin-bottom: 8px;
        transition: 0.2s;
        font-weight: 500;
        cursor: pointer;
      }
      .nav-item:hover,
      .nav-item.active {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-main);
      }
      .nav-item.active {
        border-left: 3px solid var(--accent-green);
        background: linear-gradient(
          90deg,
          rgba(0, 224, 150, 0.1) 0%,
          rgba(0, 0, 0, 0) 100%
        );
      }

      /* Main Content */
      .main-content {
        margin-left: 250px;
        padding: 30px;
        width: calc(100% - 250px);
      }

      /* --- COMPONENTS --- */
      .h-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 24px;
        height: 100%;
        position: relative;
      }

      /* Metric Value - FIXED TRUNCATION */
      .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: white;
        line-height: 1.2;
        /* Allow wrapping if needed, never hide with ... */
        white-space: normal;
        overflow: visible;
        word-break: break-word;
      }

      .metric-label {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 8px;
      }

      /* Credit Card Visual */
      .credit-card {
        background: linear-gradient(135deg, #23242e 0%, #000000 100%);
        border-radius: 20px;
        padding: 25px;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .credit-card::after {
        content: "";
        position: absolute;
        top: -50px;
        right: -50px;
        width: 150px;
        height: 150px;
        background: var(--accent-green);
        filter: blur(80px);
        opacity: 0.2;
      }

      /* Mic Button */
      .mic-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: 0.3s;
      }
      .mic-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .mic-active {
        background: rgba(255, 61, 87, 0.1) !important;
        border-color: var(--accent-red) !important;
        color: var(--accent-red) !important;
        box-shadow: 0 0 15px rgba(255, 61, 87, 0.2);
      }

      /* Tables */
      .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px;
      }
      .custom-table th {
        color: var(--text-muted);
        font-weight: 500;
        text-align: left;
        padding: 10px;
        font-size: 0.85rem;
      }
      .custom-table td {
        background: #16171f;
        padding: 16px;
        border: none;
        font-size: 0.95rem;
        vertical-align: middle;
      }
      .custom-table td:first-child {
        border-top-left-radius: 12px;
        border-bottom-left-radius: 12px;
      }
      .custom-table td:last-child {
        border-top-right-radius: 12px;
        border-bottom-right-radius: 12px;
      }

      /* Views */
      .view-section {
        display: none;
      }
      .view-section.active {
        display: block;
        animation: fadeUp 0.4s ease;
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Form Controls */
      .form-control,
      .form-select {
        background-color: #0b0c10 !important;
        border: 1px solid var(--border-color) !important;
        color: white !important;
        padding: 12px;
        border-radius: 10px;
      }
      .form-control:focus {
        border-color: var(--accent-blue) !important;
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <nav class="sidebar">
        <div class="mb-5 px-2 d-flex align-items-center gap-3">
          <div
            style="
              width: 32px;
              height: 32px;
              background: var(--accent-green);
              border-radius: 8px;
              display: grid;
              place-items: center;
              color: black;
              font-weight: bold;
            "
          >
            E
          </div>
          <h4 class="m-0 fw-bold">Echonomics</h4>
        </div>

        <div class="d-flex flex-column gap-1">
          <div
            class="nav-item active"
            onclick="switchView('overview')"
            id="nav-overview"
          >
            <i class="bi bi-grid-fill"></i> Overview
          </div>
          <div class="nav-item" onclick="switchView('health')" id="nav-health">
            <i class="bi bi-heart-pulse-fill"></i> Health Wallet
          </div>
          <div
            class="nav-item"
            onclick="switchView('insurance')"
            id="nav-insurance"
          >
            <i class="bi bi-shield-lock-fill"></i> Insurance
          </div>
          <div
            class="nav-item"
            onclick="switchView('transactions')"
            id="nav-transactions"
          >
            <i class="bi bi-list-ul"></i> Transactions
          </div>
        </div>

        <div style="margin-top: auto">
          <a href="/logout" class="nav-item text-danger"
            ><i class="bi bi-box-arrow-right"></i> Logout</a
          >
        </div>
      </nav>

      <main class="main-content">
        <header class="d-flex justify-content-between align-items-center mb-5">
          <div>
            <h3 class="fw-bold m-0" id="page-title">Dashboard</h3>
            <small class="text-muted">Welcome back, {{ user.username }}</small>
          </div>

          <div class="d-flex gap-3 align-items-center">
            <button class="mic-btn" id="micBtn" onclick="toggleMic()">
              <i class="bi bi-mic-fill" id="micIcon"></i>
              <span id="micText">Voice Log</span>
            </button>
          </div>
        </header>

        <div id="mic-status-msg" class="alert alert-danger d-none mb-4"></div>

        <div id="view-overview" class="view-section active">
          <div class="row g-4">
            <div class="col-lg-8">
              <div class="row g-4 mb-4">
                <div class="col-md-6">
                  <div
                    class="credit-card h-100 d-flex flex-column justify-content-between"
                  >
                    <div class="d-flex justify-content-between">
                      <i class="bi bi-credit-card-2-front text-white fs-4"></i>
                      <i class="bi bi-wifi text-muted"></i>
                    </div>
                    <div class="my-4">
                      <small
                        class="text-muted text-uppercase"
                        style="letter-spacing: 1px"
                        >Total Balance</small
                      >
                      <div class="metric-value mt-1" id="card-balance">
                        $0.00
                      </div>
                    </div>
                    <div
                      class="d-flex justify-content-between align-items-center"
                    >
                      <span class="text-blue fw-bold">**** 4288</span>
                      <span
                        class="badge bg-success bg-opacity-20 text-success rounded-pill px-3"
                        >Active</span
                      >
                    </div>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="h-card d-flex flex-column justify-content-center">
                    <div class="metric-label">Income</div>
                    <div
                      class="metric-value text-success"
                      style="font-size: 1.5rem"
                      id="dash-income"
                    >
                      $0.00
                    </div>
                    <small class="text-muted mt-2"
                      ><i class="bi bi-arrow-up"></i> Inflow</small
                    >
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="h-card d-flex flex-column justify-content-center">
                    <div class="metric-label">Expense</div>
                    <div
                      class="metric-value text-danger"
                      style="font-size: 1.5rem"
                      id="dash-expense"
                    >
                      $0.00
                    </div>
                    <small class="text-muted mt-2"
                      ><i class="bi bi-arrow-down"></i> Outflow</small
                    >
                  </div>
                </div>
              </div>

              <div class="h-card">
                <div
                  class="d-flex justify-content-between align-items-center mb-4"
                >
                  <h5 class="fw-bold m-0">Recent Activity</h5>
                  <button
                    class="btn btn-sm btn-link text-muted text-decoration-none"
                    onclick="switchView('transactions')"
                  >
                    See All
                  </button>
                </div>
                <table class="custom-table">
                  <tbody id="dash-table-body"></tbody>
                </table>
              </div>
            </div>

            <div class="col-lg-4">
              <div class="h-card">
                <h5 class="fw-bold mb-4">Spending Split</h5>
                <div style="height: 260px; position: relative">
                  <canvas id="mainChart"></canvas>
                </div>
                <div class="mt-4 text-center">
                  <button
                    class="btn btn-primary w-100 rounded-pill py-2 fw-bold"
                    data-bs-toggle="modal"
                    data-bs-target="#manualModal"
                  >
                    + Add Transaction
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="view-health" class="view-section">
          <div class="row g-4">
            <div class="col-lg-8">
              <div
                class="h-card mb-4"
                style="
                  background: radial-gradient(
                    circle at top right,
                    #004d40 0%,
                    #12131a 60%
                  );
                "
              >
                <div class="d-flex gap-3 align-items-center mb-3">
                  <div
                    style="
                      padding: 8px;
                      background: rgba(0, 224, 150, 0.2);
                      color: var(--accent-green);
                      border-radius: 8px;
                    "
                  >
                    <i class="bi bi-heart-pulse-fill"></i>
                  </div>
                  <h4 class="m-0 fw-bold">Health Wallet</h4>
                </div>
                <div class="metric-value mb-2" id="health-total">$0.00</div>
                <p class="text-muted small">
                  Total allocated for medical expenses
                </p>
              </div>

              <div class="h-card">
                <h5 class="fw-bold mb-4">Medical Transactions</h5>
                <table class="custom-table">
                  <thead>
                    <tr>
                      <th>Description</th>
                      <th>Date</th>
                      <th>Amount</th>
                    </tr>
                  </thead>
                  <tbody id="health-table-body"></tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-4">
              <div
                class="h-card text-center d-flex flex-column align-items-center justify-content-center"
              >
                <div
                  style="
                    width: 120px;
                    height: 120px;
                    border-radius: 50%;
                    border: 8px solid #1e2029;
                    display: grid;
                    place-items: center;
                    position: relative;
                  "
                >
                  <div
                    id="health-circle"
                    style="
                      position: absolute;
                      inset: -8px;
                      border-radius: 50%;
                      border: 8px solid var(--accent-green);
                      clip-path: inset(0 50% 0 0);
                    "
                  ></div>
                  <span class="h3 fw-bold m-0" id="health-percent">0%</span>
                </div>
                <h6 class="mt-4 fw-bold">Health Impact</h6>
                <small class="text-muted">Percentage of total expenses</small>
              </div>
            </div>
          </div>
        </div>

        <div id="view-insurance" class="view-section">
          <div class="row g-4">
            <div class="col-md-4">
              <div class="h-card">
                <i class="bi bi-hospital fs-3 text-success mb-3 d-block"></i>
                <h5 class="fw-bold">Health Ins.</h5>
                <h3 class="text-white mt-2 mb-0" id="ins-health-total">
                  $0.00
                </h3>
              </div>
            </div>
            <div class="col-md-4">
              <div class="h-card">
                <i class="bi bi-car-front fs-3 text-danger mb-3 d-block"></i>
                <h5 class="fw-bold">Car Ins.</h5>
                <h3 class="text-white mt-2 mb-0" id="ins-car-total">$0.00</h3>
              </div>
            </div>
            <div class="col-md-4">
              <div class="h-card">
                <i
                  class="bi bi-person-hearts fs-3 text-warning mb-3 d-block"
                ></i>
                <h5 class="fw-bold">Life Ins.</h5>
                <h3 class="text-white mt-2 mb-0" id="ins-life-total">$0.00</h3>
              </div>
            </div>
          </div>
          <div class="h-card mt-4">
            <h5 class="fw-bold mb-4">Insurance History</h5>
            <table class="custom-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Description</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="ins-table-body"></tbody>
            </table>
          </div>
        </div>

        <div id="view-transactions" class="view-section">
          <div class="h-card">
            <h5 class="fw-bold mb-4">All Transactions</h5>
            <table class="custom-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Category</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="all-table-body"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <div class="modal fade" id="manualModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div
          class="modal-content"
          style="
            background: var(--bg-card);
            border: 1px solid var(--border-color);
          "
        >
          <div class="modal-header border-secondary border-opacity-25">
            <h5 class="modal-title">Add Transaction</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addForm">
              <div class="mb-3">
                <label class="small text-muted mb-1">Type</label
                ><select class="form-select" id="mType">
                  <option value="Expense">Expense</option>
                  <option value="Income">Income</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="small text-muted mb-1">Amount</label
                ><input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="mAmount"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="small text-muted mb-1">Category</label
                ><input
                  type="text"
                  class="form-control"
                  id="mCategory"
                  placeholder="e.g. Food, Salary"
                />
              </div>
              <div class="mb-3">
                <label class="small text-muted mb-1">Description</label
                ><input type="text" class="form-control" id="mDesc" required />
              </div>
              <button type="submit" class="btn btn-primary w-100 fw-bold">
                Save
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- VARIABLES ---
      let transactions = [];
      const micBtn = document.getElementById("micBtn");
      const micIcon = document.getElementById("mic-icon");
      const micText = document.getElementById("micText");
      const micMsg = document.getElementById("mic-status-msg");
      const manualModal = new bootstrap.Modal(
        document.getElementById("manualModal")
      );
      let myChart = null;

      // --- NAVIGATION ---
      window.switchView = function (viewName) {
        document
          .querySelectorAll(".view-section")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(`view-${viewName}`).classList.add("active");
        if (document.getElementById(`nav-${viewName}`))
          document.getElementById(`nav-${viewName}`).classList.add("active");
        const titles = {
          overview: "Dashboard",
          health: "Health Wallet",
          insurance: "Insurance Hub",
          transactions: "All Transactions",
        };
        document.getElementById("page-title").innerText = titles[viewName];
      };

      // --- MIC & VOICE LOGIC ---
      let recognition = null;
      let isListening = false;

      // Check Browser Support
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = "en-US";

        window.toggleMic = function () {
          if (isListening) {
            recognition.stop();
          } else {
            micMsg.classList.add("d-none"); // Hide error msg
            try {
              recognition.start();
            } catch (e) {
              console.error(e);
            }
          }
        };

        recognition.onstart = () => {
          isListening = true;
          micBtn.classList.add("mic-active");
          micIcon.classList.replace("bi-mic-fill", "bi-soundwave");
          micText.innerText = "Listening...";
        };

        recognition.onend = () => {
          isListening = false;
          micBtn.classList.remove("mic-active");
          micIcon.classList.replace("bi-soundwave", "bi-mic-fill");
          micText.innerText = "Voice Log";
        };

        recognition.onresult = async (e) => {
          const text = e.results[0][0].transcript;

          let type = "Expense";
          if (text.toLowerCase().match(/received|income|salary|deposit/))
            type = "Income";

          const amount = parseVoiceAmount(text);

          let cat = "General";
          const lower = text.toLowerCase();
          if (
            lower.includes("health") ||
            lower.includes("doctor") ||
            lower.includes("med")
          )
            cat = "Health";
          else if (lower.includes("car insurance")) cat = "Car Insurance";
          else if (lower.includes("life insurance")) cat = "Life Insurance";
          else if (lower.includes("insurance")) cat = "Insurance";
          else if (lower.includes("food")) cat = "Food";

          if (amount) {
            await saveTransaction({
              amount,
              type,
              category: cat,
              description: text,
            });
          } else {
            micMsg.innerText =
              "Heard you, but couldn't understand the amount. Try saying 'Spent 50 dollars'.";
            micMsg.classList.remove("d-none");
          }
        };

        recognition.onerror = (e) => {
          isListening = false;
          micBtn.classList.remove("mic-active");
          console.error(e.error);
          micMsg.innerText = "Mic Error: " + e.error + " (Check permissions)";
          micMsg.classList.remove("d-none");
        };
      } else {
        micBtn.style.display = "none"; // Hide if not supported
      }

      function parseVoiceAmount(text) {
        const directMatch = text.match(/(\d+(\.\d+)?)/);
        if (directMatch) return parseFloat(directMatch[0]);
        // Simple word map (expand as needed)
        const map = {
          one: 1,
          ten: 10,
          twenty: 20,
          fifty: 50,
          hundred: 100,
          thousand: 1000,
        };
        return null;
      }

      // --- DATA ---
      async function fetchTransactions() {
        try {
          const res = await fetch("/api/transactions");
          if (!res.ok) throw new Error("API Failed");
          transactions = await res.json();
          renderUI();
        } catch (e) {
          console.error(e);
        }
      }

      async function saveTransaction(data) {
        await fetch("/api/transactions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        fetchTransactions();
      }

      document.getElementById("addForm").onsubmit = async (e) => {
        e.preventDefault();
        const data = {
          type: document.getElementById("mType").value,
          amount: parseFloat(document.getElementById("mAmount").value),
          category: document.getElementById("mCategory").value,
          description: document.getElementById("mDesc").value,
        };
        await saveTransaction(data);
        document.getElementById("addForm").reset();
        manualModal.hide();
      };

      // --- RENDER ---
      function renderUI() {
        let inc = 0,
          exp = 0;
        let healthTotal = 0,
          insHealth = 0,
          insCar = 0,
          insLife = 0;
        let catTotals = {};

        // DOM
        const dashBody = document.getElementById("dash-table-body");
        const healthBody = document.getElementById("health-table-body");
        const insBody = document.getElementById("ins-table-body");
        const allBody = document.getElementById("all-table-body");

        // Clear
        [dashBody, healthBody, insBody, allBody].forEach(
          (el) => (el.innerHTML = "")
        );

        transactions.forEach((t) => {
          if (t.type === "Income") inc += t.amount;
          else {
            exp += t.amount;
            catTotals[t.category] = (catTotals[t.category] || 0) + t.amount;
            // Sub-logic
            if (
              ["Health", "Medical", "Doctor", "Pharmacy"].some((k) =>
                t.category.includes(k)
              )
            ) {
              healthTotal += t.amount;
              healthBody.innerHTML += `<tr><td class="text-white">${
                t.description
              }</td><td class="text-muted">${new Date(
                t.date
              ).toLocaleDateString()}</td><td class="text-danger">-$${t.amount.toLocaleString()}</td></tr>`;
            }
            if (t.category.includes("Insurance")) {
              if (t.category.includes("Car")) insCar += t.amount;
              else if (t.category.includes("Life")) insLife += t.amount;
              else if (t.category.includes("Health")) insHealth += t.amount;
              insBody.innerHTML += `<tr><td><span class="badge bg-secondary bg-opacity-25 text-light">${
                t.category
              }</span></td><td class="text-muted">${
                t.description
              }</td><td class="text-white">$${t.amount.toLocaleString()}</td></tr>`;
            }
          }
          // All
          allBody.innerHTML += `<tr><td><span class="${
            t.type === "Income" ? "text-success" : "text-danger"
          }">${t.type}</span></td><td class="text-white">${
            t.description
          }</td><td class="text-muted">${
            t.category
          }</td><td class="fw-bold">$${t.amount.toLocaleString()}</td></tr>`;
        });

        // Top 5
        transactions.slice(0, 5).forEach((t) => {
          dashBody.innerHTML += `
                <tr>
                    <td>
                        <div class="d-flex align-items-center gap-3">
                            <div style="width:36px; height:36px; border-radius:10px; background:${
                              t.type === "Income"
                                ? "rgba(34,197,94,0.1)"
                                : "rgba(239,68,68,0.1)"
                            }; display:grid; place-items:center; color:${
            t.type === "Income" ? "#22c55e" : "#ef4444"
          };">
                                <i class="bi ${
                                  t.type === "Income"
                                    ? "bi-arrow-down-left"
                                    : "bi-arrow-up-right"
                                }"></i>
                            </div>
                            <div>
                                <div class="fw-medium text-white">${
                                  t.description
                                }</div>
                                <div class="small text-muted" style="font-size:0.75rem">${
                                  t.category
                                }</div>
                            </div>
                        </div>
                    </td>
                    <td class="text-end fw-bold ${
                      t.type === "Income" ? "text-success" : "text-white"
                    }">
                        ${
                          t.type === "Income" ? "+" : "-"
                        }$${t.amount.toLocaleString(undefined, {
            minimumFractionDigits: 2,
          })}
                    </td>
                </tr>
            `;
        });

        // Updates
        document.getElementById("card-balance").innerText = `$${(
          inc - exp
        ).toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
        document.getElementById(
          "dash-income"
        ).innerText = `$${inc.toLocaleString(undefined, {
          minimumFractionDigits: 2,
        })}`;
        document.getElementById(
          "dash-expense"
        ).innerText = `$${exp.toLocaleString(undefined, {
          minimumFractionDigits: 2,
        })}`;

        document.getElementById(
          "health-total"
        ).innerText = `$${healthTotal.toLocaleString()}`;
        document.getElementById(
          "ins-health-total"
        ).innerText = `$${insHealth.toLocaleString()}`;
        document.getElementById(
          "ins-car-total"
        ).innerText = `$${insCar.toLocaleString()}`;
        document.getElementById(
          "ins-life-total"
        ).innerText = `$${insLife.toLocaleString()}`;

        // Health Circle
        const percent = exp > 0 ? ((healthTotal / exp) * 100).toFixed(0) : 0;
        document.getElementById("health-percent").innerText = `${percent}%`;

        updateChart(catTotals);
      }

      function updateChart(data) {
        const ctx = document.getElementById("mainChart");
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: Object.keys(data),
            datasets: [
              {
                data: Object.values(data),
                backgroundColor: [
                  "#22c55e",
                  "#3b82f6",
                  "#f59e0b",
                  "#ef4444",
                  "#8b5cf6",
                ],
                borderWidth: 0,
                hoverOffset: 10,
              },
            ],
          },
          options: {
            cutout: "75%",
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  color: "#888",
                  font: { family: "Inter", size: 11 },
                  boxWidth: 10,
                  usePointStyle: true,
                },
              },
            },
          },
        });
      }

      fetchTransactions();
    </script>
  </body>
</html>

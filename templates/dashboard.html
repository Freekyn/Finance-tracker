<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard v2.0</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* --- LIQUID GLASS THEME --- */
      body {
        background-color: #000;
        color: #eee;
        font-family: "Segoe UI", sans-serif;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }
      .bg-blob {
        position: fixed;
        border-radius: 50%;
        filter: blur(80px);
        z-index: -1;
        opacity: 0.6;
      }
      .blob-1 {
        top: -10%;
        left: -10%;
        width: 500px;
        height: 500px;
        background: #560bad;
      }
      .blob-2 {
        bottom: -10%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: #3f37c9;
      }

      .glass-panel {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      /* --- MIC BUTTON --- */
      .mic-btn {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #f72585, #7209b7);
        color: white;
        font-size: 2rem;
        box-shadow: 0 0 20px rgba(247, 37, 133, 0.5);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10; /* Ensure it's on top */
      }
      .mic-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 30px rgba(247, 37, 133, 0.8);
      }

      /* ACTIVE STATE (LISTENING) - Added !important to force change */
      .mic-btn.listening {
        background: #ff0000 !important; /* Bright Red */
        box-shadow: 0 0 50px #ff0000 !important;
        animation: pulse-red 1.5s infinite;
      }

      @keyframes pulse-red {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
        }
        70% {
          transform: scale(1.1);
          box-shadow: 0 0 0 20px rgba(255, 0, 0, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
        }
      }

      /* --- SUMMARY CARDS --- */
      .summary-card {
        padding: 1.5rem;
        border-radius: 15px;
        text-align: center;
      }
      .card-income {
        background: rgba(16, 185, 129, 0.2);
        border: 1px solid rgba(16, 185, 129, 0.4);
      }
      .card-expense {
        background: rgba(244, 63, 94, 0.2);
        border: 1px solid rgba(244, 63, 94, 0.4);
      }
      .card-balance {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.4);
      }
      .amount-text {
        font-size: 1.5rem;
        font-weight: bold;
        margin-top: 5px;
      }

      /* --- FORM ELEMENTS --- */
      .form-control,
      .form-select {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
      }
      .form-control:focus,
      .form-select:focus {
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border-color: #4cc9f0;
        box-shadow: none;
      }
      .list-group-item {
        background: rgba(255, 255, 255, 0.05);
        border: none;
        color: #ddd;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 5px;
        border-radius: 8px !important;
      }

      /* --- MODAL --- */
      .modal-content {
        background: #1a1a2e;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .modal-header,
      .modal-footer {
        border-color: rgba(255, 255, 255, 0.1);
      }
      .btn-close {
        filter: invert(1);
      }
    </style>
  </head>
  <body>
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">
          Hi, <span style="color: #4cc9f0">{{ user.username }}</span>
        </h2>
        <a href="/logout" class="btn btn-outline-danger px-4 rounded-pill"
          >Logout</a
        >
      </div>

      <div class="row mb-4">
        <div class="col-md-4 mb-3">
          <div class="summary-card card-income">
            <div class="text-success small">INCOME</div>
            <div class="amount-text text-success" id="total-income">$0.00</div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="summary-card card-expense">
            <div class="text-danger small">EXPENSE</div>
            <div class="amount-text text-danger" id="total-expense">$0.00</div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="summary-card card-balance">
            <div class="text-info small">NET BALANCE</div>
            <div class="amount-text text-white" id="net-balance">$0.00</div>
          </div>
        </div>
      </div>

      <div class="glass-panel text-center">
        <h4 class="mb-3">üéôÔ∏è Voice Log</h4>
        <p class="text-white-50 mb-3">
          Tap mic to toggle. Say: <i>"Spent 50 on Food"</i>
        </p>

        <div class="d-flex justify-content-center mb-3">
          <button id="mic" class="mic-btn" onclick="toggleMic()">
            <span id="mic-icon">üéôÔ∏è</span>
          </button>
        </div>
        <p id="status" class="fw-bold text-info" style="min-height: 24px">
          Click mic to start
        </p>

        <button
          class="btn btn-sm btn-outline-light mt-3"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#manualForm"
        >
          Manual Entry
        </button>

        <div class="collapse mt-3" id="manualForm">
          <div class="card card-body bg-transparent border border-secondary">
            <form id="addForm" class="row g-2">
              <div class="col-4">
                <select class="form-select" id="mType">
                  <option value="Expense">Expense</option>
                  <option value="Income">Income</option>
                </select>
              </div>
              <div class="col-4">
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="mAmount"
                  placeholder="Amount"
                  required
                />
              </div>
              <div class="col-4">
                <input
                  type="text"
                  class="form-control"
                  id="mCategory"
                  placeholder="Category"
                  value="General"
                />
              </div>
              <div class="col-12">
                <input
                  type="text"
                  class="form-control"
                  id="mDesc"
                  placeholder="Description (e.g. Lunch)"
                  required
                />
              </div>
              <div class="col-12 mt-2">
                <button type="submit" class="btn btn-primary w-100">
                  Add Transaction
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="glass-panel h-100">
            <h5 class="mb-4 text-center">Expense Breakdown</h5>
            <div style="height: 300px; display: flex; justify-content: center">
              <canvas id="chart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="glass-panel h-100">
            <h5 class="mb-4">Recent Transactions</h5>
            <div
              style="max-height: 350px; overflow-y: auto"
              id="list-container"
            >
              <ul id="list" class="list-group list-group-flush"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Transaction</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editId" />
            <div class="mb-3">
              <label>Type</label>
              <select class="form-select" id="editType">
                <option value="Expense">Expense</option>
                <option value="Income">Income</option>
              </select>
            </div>
            <div class="mb-3">
              <label>Amount</label
              ><input
                type="number"
                step="0.01"
                class="form-control"
                id="editAmount"
              />
            </div>
            <div class="mb-3">
              <label>Category</label
              ><input type="text" class="form-control" id="editCategory" />
            </div>
            <div class="mb-3">
              <label>Description</label
              ><input type="text" class="form-control" id="editDesc" />
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <button
              type="button"
              class="btn btn-danger"
              onclick="deleteTransaction()"
            >
              Delete
            </button>
            <button type="button" class="btn btn-success" onclick="saveEdit()">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- GLOBAL VARIABLES ---
      let transactions = [];
      const editModal = new bootstrap.Modal(
        document.getElementById("editModal")
      );
      const micBtn = document.getElementById("mic");
      const micIcon = document.getElementById("mic-icon");
      const status = document.getElementById("status");
      let isListening = false;
      let recognition = null;

      // --- 1. TOGGLE LOGIC ---
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false; // Stops automatically after one sentence
        recognition.lang = "en-US";

        // --- THE TOGGLE FUNCTION ---
        window.toggleMic = function () {
          if (isListening) {
            // If currently listening, STOP it manually
            console.log("User clicked stop.");
            recognition.stop();
          } else {
            // If not listening, START it
            console.log("User clicked start.");
            try {
              recognition.start();
            } catch (e) {
              console.error("Mic start error:", e);
              // If it was already running but state desynced, stop it first
              recognition.stop();
            }
          }
        };

        // --- EVENT: STARTED LISTENING ---
        recognition.onstart = () => {
          console.log("Mic Started");
          isListening = true;

          // VISUAL UPDATES
          micBtn.classList.add("listening"); // Adds Red Pulse
          micIcon.innerText = "‚è∏Ô∏è"; // Changes to Pause Icon

          status.innerText = "Listening... (Click to Pause)";
          status.style.color = "#ff4757"; // Red Text
        };

        // --- EVENT: STOPPED LISTENING ---
        recognition.onend = () => {
          console.log("Mic Stopped");
          isListening = false;

          // VISUAL UPDATES (RESET)
          micBtn.classList.remove("listening");
          micIcon.innerText = "üéôÔ∏è";

          if (!status.innerText.includes("Processing")) {
            status.innerText = "Click mic to record";
            status.style.color = "#4cc9f0";
          }
        };

        // --- EVENT: SPEECH DETECTED ---
        recognition.onresult = async (e) => {
          const text = e.results[0][0].transcript;
          console.log("Heard:", text);
          status.innerText = `Processing: "${text}"`;

          let type = "Expense";
          if (text.toLowerCase().match(/received|income|salary|deposit/))
            type = "Income";

          const amount = parseVoiceAmount(text);

          let cat = "General";
          [
            "food",
            "travel",
            "bills",
            "rent",
            "shopping",
            "groceries",
            "salary",
          ].forEach((c) => {
            if (text.toLowerCase().includes(c))
              cat = c.charAt(0).toUpperCase() + c.slice(1);
          });

          if (amount) {
            await saveTransaction({
              amount,
              type,
              category: cat,
              description: text,
            });
            status.innerText = "Saved! Click mic to add another.";
            status.style.color = "#4cc9f0";
          } else {
            status.innerText = "‚ùå No amount heard. Try again.";
          }
        };

        recognition.onerror = (e) => {
          console.error("Speech Error:", e.error);
          isListening = false;
          micBtn.classList.remove("listening");
          micIcon.innerText = "üéôÔ∏è";
          status.innerText = "Error: " + e.error;
        };
      } else {
        micBtn.style.display = "none";
        status.innerText = "Voice not supported in this browser.";
      }

      // --- HELPER: Number Parsing ---
      const numberWords = {
        one: 1,
        two: 2,
        three: 3,
        four: 4,
        five: 5,
        six: 6,
        seven: 7,
        eight: 8,
        nine: 9,
        ten: 10,
        eleven: 11,
        twelve: 12,
        thirteen: 13,
        fourteen: 14,
        fifteen: 15,
        sixteen: 16,
        seventeen: 17,
        eighteen: 18,
        nineteen: 19,
        twenty: 20,
        thirty: 30,
        forty: 40,
        fifty: 50,
        sixty: 60,
        seventy: 70,
        eighty: 80,
        ninety: 90,
      };
      const multipliers = {
        hundred: 100,
        thousand: 1000,
        lakh: 100000,
        crore: 10000000,
      };

      function parseVoiceAmount(text) {
        const directMatch = text.match(/(\d+(\.\d+)?)/);
        if (directMatch) return parseFloat(directMatch[0]);
        let cleanText = text
          .toLowerCase()
          .replace(/-/g, " ")
          .replace(/rupees|dollars|rs/g, "");
        let words = cleanText.split(" ");
        let total = 0;
        let current = 0;
        words.forEach((w) => {
          if (numberWords[w]) current += numberWords[w];
          else if (multipliers[w]) {
            total += (current || 1) * multipliers[w];
            current = 0;
          }
        });
        return total + current || null;
      }

      // --- DATA FUNCTIONS ---
      async function fetchTransactions() {
        const res = await fetch("/api/transactions");
        transactions = await res.json();
        renderUI();
      }
      async function saveTransaction(data) {
        await fetch("/api/transactions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        fetchTransactions();
      }
      document.getElementById("addForm").onsubmit = async (e) => {
        e.preventDefault();
        const data = {
          type: document.getElementById("mType").value,
          amount: parseFloat(document.getElementById("mAmount").value),
          category: document.getElementById("mCategory").value,
          description: document.getElementById("mDesc").value,
        };
        await saveTransaction(data);
        document.getElementById("addForm").reset();
        new bootstrap.Collapse(document.getElementById("manualForm")).hide();
      };

      function renderUI() {
        const list = document.getElementById("list");
        list.innerHTML = "";
        let inc = 0,
          exp = 0,
          catTotals = {};
        transactions.forEach((t) => {
          if (t.type === "Income") inc += t.amount;
          else {
            exp += t.amount;
            catTotals[t.category] = (catTotals[t.category] || 0) + t.amount;
          }
          const color = t.type === "Income" ? "text-success" : "text-danger";
          const sign = t.type === "Income" ? "+" : "-";
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<div><div class="fw-bold">${
            t.description
          }</div><div class="small text-muted">${new Date(
            t.date
          ).toLocaleDateString()} ‚Ä¢ ${
            t.category
          }</div></div><div class="d-flex align-items-center"><span class="fw-bold ${color} me-3">${sign}$${t.amount.toFixed(
            2
          )}</span><button class="btn btn-sm btn-outline-secondary" onclick='openEdit(${JSON.stringify(
            t
          )})'>‚úèÔ∏è</button></div>`;
          list.appendChild(li);
        });
        document.getElementById("total-income").innerText = `$${inc.toFixed(
          2
        )}`;
        document.getElementById("total-expense").innerText = `$${exp.toFixed(
          2
        )}`;
        document.getElementById("net-balance").innerText = `$${(
          inc - exp
        ).toFixed(2)}`;
        updateChart(catTotals);
      }

      let myChart = null;
      function updateChart(data) {
        const ctx = document.getElementById("chart");
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: Object.keys(data),
            datasets: [
              {
                data: Object.values(data),
                backgroundColor: [
                  "#4cc9f0",
                  "#f72585",
                  "#7209b7",
                  "#4361ee",
                  "#4895ef",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom", labels: { color: "white" } },
            },
          },
        });
      }

      window.openEdit = (t) => {
        document.getElementById("editId").value = t.id;
        document.getElementById("editType").value = t.type;
        document.getElementById("editAmount").value = t.amount;
        document.getElementById("editCategory").value = t.category;
        document.getElementById("editDesc").value = t.description;
        editModal.show();
      };
      window.saveEdit = async () => {
        const id = document.getElementById("editId").value;
        const data = {
          type: document.getElementById("editType").value,
          amount: parseFloat(document.getElementById("editAmount").value),
          category: document.getElementById("editCategory").value,
          description: document.getElementById("editDesc").value,
        };
        await fetch(`/api/transactions/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        editModal.hide();
        fetchTransactions();
      };
      window.deleteTransaction = async () => {
        if (!confirm("Are you sure?")) return;
        const id = document.getElementById("editId").value;
        await fetch(`/api/transactions/${id}`, { method: "DELETE" });
        editModal.hide();
        fetchTransactions();
      };
      fetchTransactions();
    </script>
  </body>
</html>
